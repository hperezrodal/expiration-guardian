# Technical Specification – Expiration Guardian v1

## 1. Overview

This document describes the technical architecture, data models, background jobs, and system flows for **Expiration Guardian v1**.

The system is designed to be:
- Simple and reliable
- Email-first
- Easy to operate with minimal supervision
- Cheap to run and scale gradually

---

## 2. High-Level Architecture

### Core Components

- **Backend API**: NestJS (Node.js)
- **Database**: PostgreSQL
- **Email Service**: SendGrid
- **Scheduler / Workers**: Cron-based background jobs
- **Infra**: Docker Compose (1–2 machines)

### Logical Diagram (conceptual)

```
[ Client / Email ]
        |
        v
[ API (NestJS) ] ----> [ PostgreSQL ]
        |
        v
[ Email Worker / Cron ] ---> [ SendGrid ]
```

The system is **API + background jobs**. There is no real-time or streaming requirement in v1.

---

## 3. Authentication & Identity

### Auth Model

- Passwordless authentication (magic links)
- Email address is the primary identifier

### Flow
1. User enters email
2. System sends magic login link
3. Link contains short-lived token
4. Token exchanges for session

No passwords are stored.

---

## 4. Multi-Account / Tenant Model

### Concept

- One **Account** represents one individual or small entity
- One **User** (owner) per account
- Multiple **Observers** (emails only)

There is no concept of multiple active users per account in v1.

---

## 5. Core Data Models (Schemas)

> Field names are illustrative; exact naming may vary.

### Account

```sql
account
- id (uuid, pk)
- owner_email (string, unique)
- plan (enum: trial, active, canceled)
- trial_ends_at (timestamp)
- created_at
```

---

### Observer

```sql
observer
- id (uuid, pk)
- account_id (fk)
- email (string)
- created_at
```

---

### Document

```sql
document
- id (uuid, pk)
- account_id (fk)
- title (string)
- type (enum or string)
- description (text, nullable)
- expiration_date (date)
- is_recurring (boolean)
- recurrence_rule_id (fk, nullable)
- status (active, expired, archived)
- created_at
- updated_at
```

---

### RecurrenceRule

```sql
recurrence_rule
- id (uuid, pk)
- frequency (enum: monthly, annual)
- interval (int, default 1)
- horizon_months (int)
- created_at
```

---

### AlertRule

```sql
alert_rule
- id (uuid, pk)
- document_id (fk)
- days_before (int)
```

Default rules are created automatically per document.

---

### EmailEvent (Audit / Metrics)

```sql
email_event
- id (uuid, pk)
- account_id (fk)
- document_id (fk, nullable)
- type (alert, digest, confirmation)
- status (sent, opened, clicked)
- created_at
```

---

## 6. Forward Email Pipeline

### Email Ingestion

- Dedicated inbound email address (e.g. `docs@expirationguardian.com`)
- SendGrid Inbound Parse Webhook

### Processing Flow

1. Email received by SendGrid
2. Webhook POST to API
3. System extracts:
   - Sender
   - Subject
   - Plain text body
4. NLP / rule-based parsing detects:
   - Possible expiration dates
   - Possible recurrence hints
5. Draft document created in **pending** state
6. Confirmation email sent to user

---

### Confirmation Flow

- Confirmation email contains signed token
- User can:
  - Confirm
  - Edit
  - Reject

No login required.

Confirmed drafts become active documents.

---

## 7. Document Lifecycle

### States

- Draft (pending confirmation)
- Active
- Expired
- Archived

### Transitions

- Draft → Active (user confirms)
- Active → Expired (cron job)
- Expired → Archived (manual or automated)

---

## 8. Recurring Engine (v1)

### Behavior

- Runs daily
- Finds recurring documents nearing expiration
- Generates next occurrence if within horizon

### Rules

- No infinite generation
- Respect account limits
- Only one future instance per recurring chain

---

## 9. Alerting System

### Alert Scheduler

- Daily cron job
- Queries documents by expiration date
- Applies alert rules

### Alert Recipients

- Account owner
- All observers

### Idempotency

- Alerts are de-duplicated
- Each alert sent once per rule

---

## 10. Digest Generator

### Frequency

- Weekly
- Monthly

### Content Assembly

- Upcoming expirations
- Recently expired
- Recurring reminders

Digests are generated by scheduled jobs.

---

## 11. Monthly PDF Generator

### Job

- Runs monthly per account
- Generates PDF snapshot

### Storage

- Stored temporarily or regenerated on demand

No legal guarantees.

---

## 12. Cron Jobs Summary

| Job | Frequency | Purpose |
|----|---------|--------|
| Alert scheduler | Daily | Send alerts |
| Recurring engine | Daily | Generate next occurrences |
| Digest weekly | Weekly | Summary |
| Digest monthly | Monthly | Summary |
| PDF generator | Monthly | Archive snapshot |

---

## 13. Observability & Metrics

Tracked metrics:
- Documents created (manual vs forward)
- Confirmation acceptance rate
- Alerts sent / opened
- Digest engagement
- Trial conversion
- Churn

Logs are structured and stored centrally.

---

## 14. Security Considerations

- Signed tokens for magic links and confirmations
- Short token TTL
- No sensitive documents stored
- Minimal PII (emails only)

---

## 15. Scalability Notes

- Stateless API
- Background jobs can be isolated
- Postgres indexes on expiration_date
- Horizontal scaling possible without redesign

---

## 16. Out of Scope (v1)

- Real-time processing
- Billing integrations
- Mobile apps
- External provider APIs
- Advanced role management

---

**Expiration Guardian v1** prioritizes reliability, clarity, and operational simplicity over feature density.

